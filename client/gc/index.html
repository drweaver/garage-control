<!doctype html>
<html lang="en" ng-app="GcApp">
  <head>
    <title>Garage Control</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
    <style>
     body {
        padding-top: 70px;
      }
        [ng\:cloak], [ng-cloak], [data-ng-cloak], [x-ng-cloak], .ng-cloak, .x-ng-cloak {
          display: none !important;
      }
    </style>
  </head>
  <body>
    
    <div ng-controller="GcController">
      <nav class="navbar navbar-fixed-top navbar-inverse">
        <div class="container-fluid">
          <p class="navbar-left navbar-brand">
            Garage Control
          </p>
        </div>
      </nav>
    
      <div class="container">
        <button class="btn btn-primary btn-lg btn-block" ng-click="operateDoor()" ng-disabled="!canOperate">
          <span>Operate Door
            <span class="badge ng-cloak">{{status}}</span>
          </span>
        </button>
      </div>
      
      <nav class="navbar navbar-fixed-bottom navbar-inverse">
        <div class="container-fluid">
          <p class="navbar-left navbar-text ng-cloak">
            {{log}}
          </p>
        </div>
      </nav>
    </div>
    <script src="/gc/socket.io/socket.io.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.3.5/angular.min.js"></script>
    <script>
    var app = angular.module('GcApp', []);
    
    app.controller('GcController', function($scope) {
    
        var socket = io.connect( location.origin, { 'resource': 'gc/socket.io'} );
        $scope.log = 'Loading...';
        $scope.canOperate = false;
        
        $scope.checkPosition = function() {
          if( $scope.latlng ) {
            socket.emit('position', $scope.latlng, function(ok) {
              $scope.canOperate = ok;
              $scope.$apply();
            });
          } 
        };
        
        $scope.operateDoor = function() {
          $scope.canOperate = false;
          socket.emit('operate', $scope.latlng, function(msg) {
            $scope.canOperate = true;
            $scope.log = msg;
            $scope.$apply();
          });
        };
        
        socket.on('connect', function() {
          $scope.log = 'Connected';
          $scope.canOperate = false;
          $scope.checkPosition();
          $scope.$apply();
        });
        
        socket.on('reconnecting', function(num) {
          //TODO - can we make this countdown?
          $scope.log = 'Attempting reconnect in '+(num/1000)+'s';
          $scope.$apply();
        });
        
        socket.on('disconnect', function() {
          $scope.log = 'Disconnected';
          $scope.status = '';
          $scope.canOperate = false;
          $scope.$apply();
        });
        
        socket.on('status', function(status) {
          $scope.status = status;
          $scope.$apply();
        });
        
        if (navigator.geolocation) {
          var distance = function(lat1,lng1,lat2,lng2) {
            var R = 6371; // km
            var φ1 = lat1.toRadians();
            var φ2 = lat2.toRadians();
            var λ1 = lng1.toRadians();
            var λ2 = lng2.toRadians();
            var x = (λ2-λ1) * Math.cos((φ1+φ2)/2);
            var y = (φ2-φ1);
            var d = Math.sqrt(x*x + y*y) * R; 
            console.log("distance moved = " + Math.floor(d) + " km");
            return d;
          };
          /** Extend Number object with method to convert numeric degrees to radians */
          if (typeof Number.prototype.toRadians == 'undefined') {
            Number.prototype.toRadians = function() { return this * Math.PI / 180; };
          }
          var updatePos = function(position) {
            if( $scope.latlng === undefined || distance($scope.latlng.lat,$scope.latlng.lng,position.coords.latitude,position.coords.longitude) > 1) {
                $scope.$apply(function(){
                  $scope.latlng = { lat: position.coords.latitude, lng: position.coords.longitude };
                  $scope.checkPosition();
                });
            }
          };

          navigator.geolocation.getCurrentPosition(function(position) {
            updatePos(position);
            navigator.geolocation.watchPosition(updatePos);
          });
        }
        

      }); /*- end controller -*/
      
    </script>
  </body>
</html>
